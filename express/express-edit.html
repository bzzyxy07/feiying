<form class="layui-form init-select-group ignore-comm-submit" group-init-url="/api/OrderTransportOrder/PostView" lay-filter="express-edit-form" id="express_edit_form">
	<table id="express_package_table" class="layui-table">
		<thead>
			<tr>
				<th>序号</th>
				<th>包裹追踪号</th>
				<th>仓库</th>
				<th>状态</th>
				<th>重量</th>
				<th>物品</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>

	<input autocomplete="off" type="hidden" name="caozuo" value="1">
	<input autocomplete="off" type="hidden" name="kkfs" value="1">
	<input autocomplete="off" type="hidden" name="isenter" value="0">

	<table class="layui-table" id="express_edit_cont">
		<colgroup>
			<col width="130">
			<col>
			<col width="120">
			<col>
			<col width="140">
			<col>
		</colgroup>
		<tr>
			<th colspan="8" class="none-back-border">
				<p class="comm-title-dot"><span class="layui-badge-dot layui-bg-blue"></span>运单信息</p>
			</th>
		</tr>
		<tr>
			<th class="align-right">运单编号</th>
			<td class="gray-back">
				<input autocomplete="off" name="cnum" fill-name="cnum" class="field-cont layui-input none-back-border" disabled="disabled"></span>
				<input autocomplete="off" name="Id" fill-name="id" class="field-cont" type="hidden"></span>
			</td>
			<th class="align-right">创建时间</th>
			<td class="gray-back">
				<input autocomplete="off" name="" class="field-cont layui-input none-back-border" fill-name="createtime" class="field-cont layui-input" disabled="disabled"></span>
			</td>

			<th class="align-right required-logo">送达仓库</th>
			<td>
				<select name="depotid" initial-name="depot_list" lay-verify="required" class="field-cont" fill-name="depotid"></select>
			</td>
			<th class="align-right required-logo">线路名称</th>
			<td>
				<select name="routeid" initial-name="routes" initial-text="routename" lay-verify="required" class="field-cont" fill-name="routeid"></select>
			</td>
		</tr>
		<tr>
			<th colspan="8" class="none-back-border">
				<p class="comm-title-dot">
					<span class="layui-badge-dot layui-bg-blue"></span>发件人信息
					<span class="float-right">
						<input autocomplete="off" type="checkbox" name="save-deliver" title="保存发件人" lay-skin="primary" checked>
						<button type="button" class="layui-btn layui-btn-sm float-right" id="choose_deliver">选择发件人</button>
					</span>
				</p>
			</th>
		</tr>
		<tr>
			<th class="align-right required-logo">姓名</th>
			<td>
				<input autocomplete="off" name="delivername" class="field-cont layui-input" fill-name="delivername" fill-deliver="delivername" lay-verify="required">
			</td>
			<th class="align-right required-logo">电话</th>
			<td>
				<input autocomplete="off" name="delivermobile" class="field-cont layui-input" fill-name="delivermobile" fill-deliver="mobilephone" lay-verify="required">
			</td>
			<th class="align-right">地址</th>
			<td colspan="3">
				<input autocomplete="off" name="deliveraddress" class="field-cont layui-input" fill-name="deliveraddress" fill-deliver="deliveraddress">
			</td>
		</tr>
		<tr>
			<th colspan="8" class="none-back-border">
				<p class="comm-title-dot">
					<span class="layui-badge-dot layui-bg-blue"></span>收件人信息
					<span class="float-right">
						<input autocomplete="off" type="checkbox" name="save-receiver" title="保存收件人" lay-skin="primary" checked>
						<button type="button" class="layui-btn layui-btn-sm" id="choose_receiver">选择收件人</button>
					</span>
				</p>
			</th>
		</tr>
		<tr>
			<th class="align-right required-logo">收件人姓名</th>
			<td>
				<input autocomplete="off" name="receivername" class="field-cont layui-input" id="express_receiver_id" type="text" fill-name="receivername" fill-receiver="receivername" lay-verify="required">
			</td>
			<th class="align-right required-logo">手机号码</th>
			<td>
				<input autocomplete="off" name="receivermobile" class="field-cont layui-input" fill-name="receivermobile" lay-verify="required|phone" fill-receiver="receivermobile">
			</td>
			<th class="align-right" rowspan="2">证件正面照片</th>
			<td rowspan="2">
				<div class="upload-img-container">
					<a href="javascript:;">
						<span>点此上传</span>
						<input autocomplete="off" type="file" name="" class="layui-input upload-img-file" accept=accept="image/gif, image/x-png, image/pjpeg, image/jpeg, image/bmp">
						<input autocomplete="off" type="hidden" name="idcardzheng" class="upload-img-url field-cont" fill-name="receiveridcard_zheng" fill-receiver="idcardzheng">
					</a>
					<img class="upload-img" alt="暂无图片">

				</div>
			</td>
			<th class="align-right" rowspan="2">证件反面照片</th>
			<td rowspan="2">
				<div class="upload-img-container">
					<a href="javascript:;">
						<span>点此上传</span>
						<input autocomplete="off" type="file" name="" class="layui-input upload-img-file" accept=accept="image/gif, image/x-png, image/pjpeg, image/jpeg, image/bmp">
						<input autocomplete="off" type="hidden" name="idcardfan" class="upload-img-url field-cont" fill-name="receiveridcard_fan" fill-receiver="idcardfan">
					</a>
					<img class="upload-img" alt="暂无图片">
				</div>
			</td>
		</tr>
		<tr>
			<th class="align-right">证件类型</th>
			<td>
				<select name="receiveridcardtype" class="field-cont layui-input" initial-name="id_cards" initial-text="Text" initial-value="Value" fill-name="receiveridcardtype" fill-receiver="receiveridcardtype"></select>
			</td>
			<th class="align-right">证件号码</th>
			<td>
				<input autocomplete="off" type="text" name="receiveridcardnum" class="field-cont layui-input" fill-name="receiveridcardnum" fill-receiver="idcardnumber">
			</td>
		</tr>
		<tr>
			<th class="align-right required-logo">省市地址</th>
			<td class="relation-select" colspan="5">
				<div class="layui-input-inline">
					<select name="receiverregion_province" lay-filter="relate-province" id="province" class="field-cont" fill-name="receiverregion_province" lay-verify="required" fill-receiver="regionprovince"></select>
				</div>
				<div class="layui-input-inline">
					<select name="receiverregion_city" lay-filter="relate-city" id="city" class="field-cont" fill-name="receiverregion_city" lay-verify="required" fill-receiver="regioncity"></select>
				</div>
				<div class="layui-input-inline" style="width: 350px;">
					<input autocomplete="off" name="receiveraddress" class="field-cont layui-input" placeholder="请输入详细地址" fill-name="receiveraddress" fill-receiver="receiveraddress" lay-verify="required">
				</div>
			</td>
			<th class="align-right required-logo">邮编</th>
			<td>
				<input autocomplete="off" name="ReceiverPostCard" id="zipcode" class="field-cont layui-input" fill-name="receiverpostcard" fill-receiver="zipcode" lay-verify="required|number">
			</td>
		</tr>
		<tr>
			<th colspan="8" class="none-back-border">
				<p class="comm-title-dot"><span class="layui-badge-dot layui-bg-blue"></span>包裹明细</p>
			</th>
		</tr>
		<tr>
			<th class="align-right required-logo">物品明细</th>
			<td colspan="7">
				<table class="layui-table margin-0 table-inner-table" lay-size="sm">
					<thead>
						<tr>
							<th class="required-logo">类别</th>
							<th class="required-logo">物品名称</th>
							<th class="required-logo">规格</th>
							<th class="required-logo">品牌</th>
							<th class="required-logo">数量</th>
							<th class="required-logo">单价($)</th>
							<th class="required-logo">单位</th>
							<th><button type="button" class="layui-btn layui-btn-sm layui-btn-normal" id="add_detail_tr_btn">添加</button></th>
						</tr>
					</thead>
					<tbody id="detail_body">
						<tr class="detail-tr">
							<td>
								<select name="taxcategoryid" fill-name="taxcategoryid" class="field-cont" lay-verify="required" initial-name="category" initial-text="categoryname"></select>
							</td>
							<td><input autocomplete="off" type="text" name="Mingcheng" fill-name="mingcheng" placeholder="请输入物品名称" lay-verify="required" autocomplete="off" class="field-cont layui-input"></td>
							<td><input autocomplete="off" type="text" name="Guige" fill-name="guige" placeholder="请输入物品规格" lay-verify="required" autocomplete="off" class="field-cont layui-input"></td>
							<td><input autocomplete="off" type="text" name="Pinpai" fill-name="pinpai" placeholder="请输入物品品牌" lay-verify="required" autocomplete="off" class="field-cont layui-input"></td>
							<td><input autocomplete="off" type="text" name="Count" fill-name="count" placeholder="请输入物品数量" lay-verify="required|number" autocomplete="off" class="field-cont layui-input"></td>
							<td><input autocomplete="off" type="text" name="Danjia" fill-name="danjia" placeholder="请输入物品单价" lay-verify="required|number" autocomplete="off" class="field-cont layui-input"></td>
							<td>
								<select name="Danwei" fill-name="danwei" initial-name="units" lay-verify="required" initial-text="dictionaryname" initial-value="dictionaryname" class="field-cont layui-input"></select>
							</td>
							<td><button type="button" class="layui-btn layui-btn-sm layui-btn-danger del-detail-tr">删除</button></td>
						</tr>
					</tbody>
				</table>
			</td>
		</tr>
		<tr>
			<th class="align-right">其他费用（$）</th>
			<td>
				<input autocomplete="off" name="freeother" class="field-cont layui-input" fill-name="freeother">
			</td>
			<th class="align-right">保额（$）</th>
			<td>
				<input autocomplete="off" name="safefreeover" fill-name="safefreeover" class="field-cont layui-input">
			</td>
			<th class="align-right">税金（$）</th>
			<td>
				<input autocomplete="off" name="freecoupon" fill-name="freecoupon" class="field-cont layui-input">
			</td>
			<th class="align-right">可用积分</th>
			<td>
				<select></select>
			</td>
		</tr>
		<tr>
			<th class="align-right">增值服务</th>
			<td colspan="7" id="service_container"></td>
		</tr>
		<tr>
			<th class="align-right">备注</th>
			<td colspan="7">
				<textarea autocomplete="off" name="note" fill-name="note" class="field-cont layui-textarea"></textarea>
			</td>
		</tr>
	</table>
	<button lay-submit class="layui-btn layui-btn-normal auto-center" style="width: 200px;margin: 20px auto;">保存</button>
</form>
<script>
	layui.use(['form', 'element', 'table'], function() {
		var cloneLine = $(".detail-tr").first().clone();
		var form = layui.form;
		var table = layui.table;

		comm.getDataByCondition({
			loading: true,
			ajax: {
				url: "/api/OrderTransportOrder/DealPendingOrderInitMy",
				data: {
					id: $("#main_container").data("data")
				},
				type: "get",
				success: function(data) {
					console.info(data);
					//初始化表格选项数据
					comm.groupInitial({
						data: data,
						cont: '#express_edit_cont',
						cb: function(data) {

							//初始化省市联动
							comm.initRelateSelect({
								container: ["#express_edit_cont #province", "#express_edit_cont #city"],
								data: data["region"],
								zipcode: "#express_edit_cont #zipcode"
							});
							//添加行
							$("#express_edit_form #add_detail_tr_btn").unbind("click").on("click", function() {
								$("#express_edit_form #detail_body").append("<tr class='detail-tr'>" + $(".detail-tr").first().html() + "</tr>");
								$("#express_edit_form #detail_body .detail-tr").last().find("select,input").val("");
								form.render('select');
							});

							var orderInfo = data['orderdetails'];
							comm.fillFormByData(orderInfo, $("#express_edit_form"), "fill-name");
							//判断是否为转运运单
							if(orderInfo.source === "转运") {
								$("#express_package_table").show();
								//								var data = orderInfo.details,
								//								ids = [],tbodyStr="";
								//								data.map(function(i, index) {
								//									ids.push(i.id);
								//									tbodyStr += "<tr>";
								//									names.map(function(v) {
								//										if(v === "index") {
								//											tbodyStr += "<td>" + (index + 1) + "</td>";
								//										} else if(v === "zhuangtai") {
								//											tbodyStr += "<td>已到库</td>";
								//										} else {
								//											tbodyStr += "<td>" + i[v] + "</td>";
								//										}
								//									});
								//									tbodyStr += "</tr>";
								//								});
								//								console.info(ids)
								//								$("#express_package_table tbody").html(tbodyStr);
							} else {
								$("#express_package_table").hide();
							}
							//加载增值服务
							var freeservicenotestr = orderInfo['freeservicenote'];
							if(freeservicenotestr) {
								var freeservicenotearr0 = freeservicenotestr.split(";");
								var freeservicenotearrs = [];
								var freeservicenotearrIds = [];
								freeservicenotearr0.map(function(v) {
									var a = v.split("*");
									if(a.length == 2) {
										freeservicenotearrs.push(a);
										freeservicenotearrIds.push(a[0]);
									}
								});
							}

							var servicelist = data['servicelist'];
							var servStr = "";
							servicelist.map(function(v) {
								if(freeservicenotearrIds && (freeservicenotearrIds.indexOf(v.id) === -1)) {
									servStr += '<div style="margin: 5px 0;">' + '<input type="checkbox" data-id="' + v.id + '" name="" lay-skin="primary">' +
										'<div class="layui-input-inline" style="margin:0 5px;">' +
										'<input data-ref="' + v.id + '" class="layui-input" type="text" placeholder="请输入数量"></div>' +
										v.servicename + '（' + v.remark + '）' + '</div>';
								} else {
									var num = freeservicenotearrs[freeservicenotearrIds.indexOf(v.id)][1];
									servStr += '<div style="margin: 5px 0;">' + '<input type="checkbox" checked="checked" data-id="' + v.id + '" name="" lay-skin="primary">' +
										'<div class="layui-input-inline" style="margin:0 5px;">' +
										'<input data-ref="' + v.id + '" class="layui-input" type="text" placeholder="请输入数量" value="' + num + '"></div>' +
										v.servicename + '（' + v.remark + '）' + '</div>';
								}
							});
							$("#express_edit_form #service_container").html(servStr);

							var details = orderInfo['details'];
							for(var i = 0, len = details.length - 1; i < len; i++) {
								$("#express_edit_form #detail_body").append("<tr class='detail-tr'>" + $("#express_edit_form #detail_body .detail-tr").first() + "</tr>");
								$("#express_edit_form #detail_body .detail-tr").last().find("select,input").val("");
							}

							details.map(function(v, index, arr) {
								for(var key in v) {
									var $cont = $("#express_edit_form #detail_body .detail-tr:eq(" + index + ")").find("*[fill-name='" + key + "']");
									if($cont.prop('tagName') === 'SELECT') {
										$cont.find("option[value=" + v[key] + "]").attr("selected", "selected");
									} else {
										$cont.val(v[key]);
									}
									$cont.data("data", v[key])
								}
							});
							form.render();
						}
					});

				}
			}
		});

		//删除行
		$("#express_edit_form #detail_body").unbind("click").on("click", ".del-detail-tr", function() {
			$(this).parent().parent("tr").remove();
		});

		//选定收件人
		$("#express_edit_form #choose_receiver").on("click", function() {
			comm.openPage({
				url: './receiver/receiver-list.html?target=express-online-order',
				open: {
					maxmin: true,
					area: ['80%', '700px'],
					title: '选择收件人'
				},
				cb: function() {
					//                  $("#express_edit_form *[fill-receiver]").
				}
			});
		});
		//选定发件人
		$("#express_edit_form #choose_deliver").on("click", function() {
			comm.openPage({
				url: './deliver/deliver-list.html?target=express-online-order',
				open: {
					maxmin: true,
					area: ['800px', '700px'],
					title: '选择发件人'
				},
				cb: function() {

				}
			});
		});

		var receiverChangeFlag = 0;
		$('#express_edit_form *[fill-receiver]').on('change', function() {
			if($('#express_online_order_form input[name="save-receiver"]').hasClass("choosed")) {
				receiverChangeFlag = 1;
			}
		});
		var deliverChangeFlag = 0;
		$('#express_edit_form *[fill-deliver]').on('change', function() {
			if($('#express_online_order_form input[name="save-deliver"]').hasClass("choosed")) {
				deliverChangeFlag = 1;
			}
		});

		//提交编辑运单
		form.on('submit(express-edit-form)', function(data) {
			var a = $("#express_edit_form *[name=receiveridcardtype]").val(),
				b = $("#express_edit_form *[name=receiveridcardnum]").val(),
				c = $("#express_edit_form *[name=idcardzheng]").val(),
				d = $("#express_edit_form *[name=idcardfan]").val(),
				e = $("#express_edit_form *[name=receivername]").val(),
				f = $("#express_edit_form *[name=delivername]").val(),
				g = $("#express_edit_form *[name=delivermobile]").val(),
				h = $("#express_edit_form *[name=deliveraddress]").val();
			//保存发件人 
			if($('.choosed[name="save-deliver"]:checked').length && deliverChangeFlag) {
				comm.getDataByCondition({
					ajax: {
						url: "/api/BasicDeliver/Post",
						type: "post",
						data: {
							delivername: f,
							mobilephone: g,
							deliveraddress: h,
							zipcode: "",
							email: "",
						},
						success: function(data) {}
					}
				});
			}
			//保存收件人 
			if($('#express_edit_form .choosed[name="save-receiver"]:checked').length && receiverChangeFlag) {
				comm.getDataByCondition({
					ajax: {
						url: "/api/BasicReceiver/Post",
						type: "post",
						data: {
							receivername: e,
							receiveraddress: $("#express_edit_form *[name=receiveraddress]").val(),
							mobilephone: $("#express_edit_form *[name=receivermobile]").val(),
							zipcode: $("#express_edit_form *[name=ReceiverPostCard]").val(),
							regionprovince: $("#express_edit_form *[name=receiverregion_province]").val(),
							regioncity: $("#express_edit_form *[name=receiverregion_city]").val(),
							receiveridcardtype: a,
							idcardnumber: b,
							idcardzheng: $("#express_edit_form *[name=idcardzheng]").val(),
							idcardfan: $("#express_edit_form *[name=idcardfan]").val(),
							idcardall: "",
						},
						success: function(data) {}
					}
				});
			}
			//保存身份证信息
			if(!$('#express_edit_form input[name="save-receiver"]').hasClass("choosed") || receiverChangeFlag) {
				a && b && c && d && comm.getDataByCondition({
					ajax: {
						url: "/api/BasicIDCard/PostMy",
						type: "post",
						data: {
							username: e,
							idcardnumber: b,
							idcardzheng: c,
							idcardfan: d,
						},
						success: function(data) {}
					}
				});
			}

			var expressEditData = comm.getFormData(
				$("#express_edit_form"), [
					'caozuo', 'kkfs', 'isenter', 'Id', 'depotid', 'routeid', 'delivername', 'deliveraddress', 'delivermobile', 'deliveremail', 'receivercompany', 'receivername', 'receiveraddress', 'receiverregion_qu', 'receiverregion_city', 'receiverregion_province', 'receiverregion_national', 'idcardzheng', 'idcardfan', 'ReceiverPostCard', 'receivermobile', 'receivertele', 'receiveremail', 'receiveridcardtype', 'receiveridcardnum', 'weight', 'width', 'height', 'safefreeover', 'freeother', 'freecoupon', 'volumeweight', 'note', 'freeservicenote', 'idcard_fan', 'idcard_zheng'
				]
			);

			//整理增值服务信息
			var servDoms = $("#service_container input[type=checkbox]:checked"),
				servStr = "";
			servDoms.each(function(v) {
				var refNum = $("#service_container input[data-ref=" + $(this).attr("data-id") + "]").val() || 1;
				servStr += $(this).attr("data-id") + "*" + refNum + ";";
			});
			expressEditData.freeservicenote = servStr;

			var details = [];
			$("#express_edit_form .detail-tr").each(function() {
				var sepDetail = {}
				$(this).find('input:not(.layui-unselect), select').each(function() {
					sepDetail[$(this).attr("name")] = $(this).val();
				});
				details.push(sepDetail);
			});
			expressEditData.details = details;

			comm.getDataByCondition({
				loading: true,
				ajax: {
					url: "/api/OrderTransportOrder/Handle",
					type: "put",
					//data: new FormData($form[0]),
					data: expressEditData,
					success: function(data) {
						layer.confirm("编辑成功！", {
							icon: 1
						}, function() {
							comm.returnPrev();
						});
						//						layer.msg("编辑成功！");
						//						comm.returnPrev();
						//						comm.closeOpenPage();
					}
				}
			});
			return false;
		});

	});
</script>